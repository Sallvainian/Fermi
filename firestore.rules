rules_version = '2';
// PRODUCTION VERSION - Secure rules for live deployment
// Last updated: 2025-01-14
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if email has valid school domain
    function hasValidSchoolDomain() {
      return hasTeacherDomain() || hasStudentDomain() || hasAdminDomain();
    }
    
    // Helper function to check if user has valid teacher domain
    function hasTeacherDomain() {
      return isAuthenticated() &&
             request.auth.token.email != null &&
             request.auth.token.email.matches('(?i).*@roselleschools[.]org$');
    }
    
    // Helper function to check if user has valid student domain
    function hasStudentDomain() {
      return isAuthenticated() &&
             request.auth.token.email != null &&
             request.auth.token.email.matches('(?i).*@rosellestudent[.]org$');
    }
    
    // Helper function to check if user has valid admin domain
    function hasAdminDomain() {
      return isAuthenticated() &&
             request.auth.token.email != null &&
             request.auth.token.email.matches('(?i).*@fermi-plus[.]com$');
    }
    
    // Helper function to get user role from database (with caching)
    function getUserRole(userId) {
      let doc = get(/databases/$(database)/documents/users/$(userId));
      return doc != null && doc.data != null && doc.data.role != null ? doc.data.role : null;
    }
    
    // Helper function to check if user is THE teacher
    function isTheTeacher() {
      let role = getUserRole(request.auth.uid);
      return isAuthenticated() && 
             role != null && 
             role == 'teacher' &&
             (hasTeacherDomain() || isAdmin());
    }
    
    // Helper function to check if user is a student
    function isStudent() {
      let role = getUserRole(request.auth.uid);
      return isAuthenticated() && 
             role != null && 
             role == 'student' &&
             (hasStudentDomain() || isAdmin());
    }
    
    // Helper function to check if user is a Firebase Administrator
    function isAdmin() {
      let role = getUserRole(request.auth.uid);
      return isAuthenticated() &&
             role != null &&
             role == 'admin' &&
             hasAdminDomain();
    }
    
    // Helper function to check if student is enrolled in a class
    function isEnrolledInClass(classId) {
      return isStudent() &&
        request.auth.uid in get(/databases/$(database)/documents/classes/$(classId)).data.studentIds;
    }

    // Users collection
    match /users/{userId} {
      // Allow users to read themselves, teachers/admins can read all
      // Students can read other students (for now - proper class filtering needs Cloud Functions)
      allow read: if isAuthenticated() && (
                     request.auth.uid == userId ||  // Can read own profile
                     isTheTeacher() ||               // Teachers can read all users
                     isAdmin() || isTheTeacher() ||                    // Admins can read all users
                     (isStudent() && hasValidSchoolDomain())  // Students can read other students
                   );
      // Allow users to create their own profile if it doesn't exist yet AND they have valid school domain
      allow create: if isAuthenticated() && 
                       request.auth.uid == userId &&
                       request.resource.data.uid == userId &&
                       hasValidSchoolDomain();
      // Users can update their own document, admins can write any
      allow update: if isOwner(userId) || isAdmin() || isTheTeacher();
      // Only admins can delete user documents
      allow delete: if isAdmin() || isTheTeacher();
    }
    
    // Public usernames collection - safe for unauthenticated access
    // Only contains username -> uid mapping, no sensitive data
    match /public_usernames/{username} {
      // Allow anyone to read for username lookups during login
      allow read: if true;
      // Allow authenticated users to create their own username mapping, only for their own username
      allow create: if isAuthenticated() &&
                       request.resource.data.uid == request.auth.uid &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.username == username;
      // Only allow admins to update or delete
      allow update, delete: if isAdmin() || isTheTeacher();
    }
    
    
    // Classes - secured access with enrollment validation
    match /classes/{classId} {
      // Allow read if:
      // - User is the teacher OR
      // - User is admin OR
      // - Document doesn't exist (checking before creation) OR
      // - Any authenticated user (needed for enrollment code queries) OR
      // - User is enrolled in the class
      allow read: if isTheTeacher() || 
                     isAdmin() || isTheTeacher() ||
                     resource == null ||
                     isAuthenticated();
      
      // Teacher or admin can create classes
      allow create: if (isTheTeacher() && request.resource.data.teacherId == request.auth.uid) ||
                       isAdmin() || isTheTeacher();
      
      // Updates allowed for teacher or any user self-enrollment
      allow update: if isTheTeacher() ||
                       (isAuthenticated() &&
                        true &&
                        isStudent() &&
                        // Allow students to add themselves to studentIds array using arrayUnion
                        // Only studentIds and updatedAt fields can be modified
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['studentIds', 'updatedAt']) &&
                        // Prevent already enrolled students from re-enrolling
                        // This simple check works with FieldValue.arrayUnion()
                        !(request.auth.uid in resource.data.studentIds));
         
      // Teacher or admin can delete classes
      allow delete: if (isTheTeacher() && resource.data.teacherId == request.auth.uid) ||
                        isAdmin() || isTheTeacher();

      // Student Points Aggregate subcollection (NEW behavior points system)
      match /studentPoints/{studentId} {
        // Teachers can read all, students can read their own
        allow read: if isTheTeacher() ||
                       isAdmin() || isTheTeacher() ||
                       (isStudent() && request.auth.uid == studentId);

        // Only teachers can write (with atomic operations)
        allow create, update: if isTheTeacher();

        // Only admins can delete (for cleanup after migration)
        allow delete: if isAdmin() || isTheTeacher();

        // History subcollection for audit trail
        match /history/{historyId} {
          // Teachers can read all, students can read their own
          allow read: if isTheTeacher() ||
                         isAdmin() || isTheTeacher() ||
                         (isStudent() && studentId == request.auth.uid);

          // Only teachers can create history entries
          allow create: if isTheTeacher();

          // Teachers can update history entries (for undo operations marking isUndone = true)
          allow update: if isTheTeacher();

          // Only admins can delete (for cleanup)
          allow delete: if isAdmin() || isTheTeacher();
        }
      }

      // Behaviors subcollection for class-specific behaviors
      match /behaviors/{behaviorId} {
        // Teachers and students in the class can read behaviors
        allow read: if isTheTeacher() ||
                       isAdmin() || isTheTeacher() ||
                       isEnrolledInClass(classId);

        // Only teachers can manage behaviors
        allow create, update: if isTheTeacher();

        // Only teachers or admins can delete behaviors
        allow delete: if isTheTeacher() || isAdmin() || isTheTeacher();
      }

      // Other nested collections in classes
      match /{document=**} {
        allow read: if isTheTeacher() || isEnrolledInClass(classId);
        allow write: if isTheTeacher();
      }
    }
    
    // Messages and conversations (legacy - being phased out)
    // SECURE RULES - Participant validation enforced
    match /conversations/{conversationId} {
      // Only allow participants to read conversations
      allow read: if isAuthenticated() &&
                     (resource == null ||  // Allow existence check
                      request.auth.uid in resource.data.participants);

      // Create conversation if user is a participant (NO EMAIL VERIFICATION)
      allow create: if isAuthenticated() &&
                       request.auth.uid in request.resource.data.participants;

      // Update conversation if already a participant
      allow update: if isAuthenticated() &&
                       resource != null &&
                       request.auth.uid in resource.data.participants;

      allow delete: if false; // Never allow deletion

      match /messages/{messageId} {
        // Only allow participants to read messages
        allow read: if isAuthenticated() &&
                      request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;

        // Create message if authenticated, sender matches, and user is participant
        allow create: if isAuthenticated() &&
                        (request.auth.uid == request.resource.data.authorId ||
                         request.auth.uid == request.resource.data.senderId) &&
                        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;

        allow update: if false; // Messages are immutable
        allow delete: if false; // Messages cannot be deleted
      }

      // Typing indicators subcollection
      match /typing/{userId} {
        // Allow authenticated users to see typing status
        allow read: if isAuthenticated();

        // Only update your own typing status
        allow write: if isAuthenticated() &&
                       request.auth.uid == userId;

        allow delete: if isAuthenticated() &&
                        request.auth.uid == userId;
      }
    }
    
    // Chat rooms (NEW - camelCase version used by SimpleUserList)
    match /chatRooms/{chatRoomId} {
      // Allow authenticated users to read chatRooms to check for existing chats
      allow read: if isAuthenticated();
      // Allow authenticated users to create new chat rooms if they're a participant
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participantIds &&
                       true;
      // Allow participants to update
      allow update: if isAuthenticated() && 
                       request.auth.uid in resource.data.participantIds;
      // Allow participants to delete chat rooms they're part of
      allow delete: if isAuthenticated() && 
                       request.auth.uid in resource.data.participantIds;
      
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
                      request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(chatRoomId)).data.participantIds;
        allow create: if isAuthenticated() && 
                        request.auth.uid == request.resource.data.senderId &&
                        request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(chatRoomId)).data.participantIds &&
                        true;
        allow update: if false; // Messages are immutable
        // Allow authenticated users to delete messages (simplified for chat deletion)
        allow delete: if isAuthenticated();
      }
    }
    
    // Chat rooms (OLD - snake_case version, keeping for compatibility)
    match /chat_rooms/{chatRoomId} {
      // Allow read if authenticated AND either:
      // - User is the teacher OR
      // - Document doesn't exist (for checking before creation) OR  
      // - User is in participantIds
      allow read: if isAuthenticated() && 
                     (isTheTeacher() || 
                      resource == null ||
                      request.auth.uid in resource.data.participantIds);
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participantIds &&
                       true;
      allow update: if isAuthenticated() && 
                       (isTheTeacher() || request.auth.uid in resource.data.participantIds) &&
                       // Prevent removing other participants unless teacher
                       (isTheTeacher() || request.resource.data.participantIds.hasAll(resource.data.participantIds));
      allow delete: if false; // Don't allow deletion
      
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
                      request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(chatRoomId)).data.participantIds;
        allow create: if isAuthenticated() && 
                        request.auth.uid == request.resource.data.senderId &&
                        request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(chatRoomId)).data.participantIds &&
                        true;
        allow update: if false; // Messages are immutable
        allow delete: if isTheTeacher() || 
                        (isAuthenticated() && request.auth.uid == resource.data.senderId);
      }
    }
    
    // Assignments - secured with class enrollment validation
    match /assignments/{assignmentId} {
      // Students can only read assignments for classes they're enrolled in
      allow read: if isTheTeacher() || 
                     resource == null ||
                     (isStudent() && resource.data.classId != null && isEnrolledInClass(resource.data.classId));
      
      // Only THE teacher can create assignments
      allow create: if isTheTeacher() && 
                       request.resource.data.teacherId == request.auth.uid;
      
      // Only THE teacher can update or delete assignments
      allow update: if isTheTeacher() && 
                       resource.data.teacherId == request.auth.uid;
      allow delete: if isTheTeacher() && 
                       resource.data.teacherId == request.auth.uid;
    }
    
    // Grades - strict access control
    match /grades/{gradeId} {
      // Students can only read their own grades, teacher can read all
      allow read: if isTheTeacher() || 
                     resource == null ||
                     (isStudent() && resource.data.studentId != null && request.auth.uid == resource.data.studentId);
      
      // Only THE teacher can manage grades
      allow create: if isTheTeacher() && 
                       request.resource.data.teacherId == request.auth.uid;
      allow update: if isTheTeacher() && 
                       resource.data.teacherId == request.auth.uid;
      allow delete: if isTheTeacher() && 
                       resource.data.teacherId == request.auth.uid;
    }
    
    // Collection group queries for grades (teacher analytics only)
    match /{path=**}/grades/{gradeId} {
      allow read: if isTheTeacher();
    }

    // Collection group queries for behavior history (teacher access only)
    match /{path=**}/history/{historyId} {
      // Teachers can read all history entries for collection group queries
      // Also check if the history entry belongs to a class the teacher owns
      allow read: if isTheTeacher() || isAdmin() || isTheTeacher() ||
                     (isAuthenticated() &&
                      resource != null &&
                      resource.data.classId != null &&
                      exists(/databases/$(database)/documents/classes/$(resource.data.classId)) &&
                      get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.teacherId == request.auth.uid);
    }
    
    // Submissions - students submit, teacher reviews
    match /submissions/{submissionId} {
      // Read access for owner or teacher
      allow read: if isTheTeacher() || 
                     resource == null ||
                     (isStudent() && resource.data.studentId != null && request.auth.uid == resource.data.studentId);
      
      // Students can create their own submissions with email verification
      allow create: if isStudent() && 
                       request.auth.uid == request.resource.data.studentId &&
                       true;
      
      // Students can update only if not submitted, teacher can always update (for grading)
      allow update: if (isStudent() && 
                        request.auth.uid == resource.data.studentId && 
                        resource.data.submittedAt == null &&
                        // Prevent changing studentId
                        request.resource.data.studentId == resource.data.studentId) ||
                       isTheTeacher();
        
      // Only teacher can delete submissions
      allow delete: if isTheTeacher();
    }
    
    // Announcements - students can read, only teacher can write
    match /announcements/{announcementId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isTheTeacher();
    }
    
    // Discussion Boards - authenticated users can participate
    match /discussion_boards/{boardId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       true;
      allow update: if isAuthenticated() && 
                       request.auth.uid == resource.data.createdBy;
      allow delete: if isTheTeacher();
                       
      // Discussion threads within boards
      match /threads/{threadId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && 
                         true;
        allow update: if isAuthenticated() && 
                         (request.auth.uid == resource.data.authorId ||
                          // Allow any authenticated user to update only the likeCount
                          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeCount']) &&
                           (request.resource.data.likeCount == resource.data.likeCount + 1 ||
                            request.resource.data.likeCount == resource.data.likeCount - 1)) ||
                          // Allow any authenticated user to update only the replyCount
                          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyCount']) &&
                           (request.resource.data.replyCount == resource.data.replyCount + 1 ||
                            request.resource.data.replyCount == resource.data.replyCount - 1)));
        allow delete: if isTheTeacher() || 
                         (isAuthenticated() && request.auth.uid == resource.data.authorId);
                         
        // Comments within threads (used by thread_detail_screen.dart)
        match /comments/{commentId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated() && 
                           true;
          allow update: if isAuthenticated() && 
                           request.auth.uid == resource.data.authorId;
          allow delete: if isTheTeacher() || 
                           (isAuthenticated() && request.auth.uid == resource.data.authorId);
        }
        
        // Replies within threads (used by discussion_provider.dart)
        match /replies/{replyId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated() && 
                           true;
          allow update: if isAuthenticated() && 
                           (request.auth.uid == resource.data.authorId ||
                            // Allow any authenticated user to update only the likeCount
                            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeCount']) &&
                             request.resource.data.likeCount == resource.data.likeCount + 1 ||
                             request.resource.data.likeCount == resource.data.likeCount - 1));
          allow delete: if isTheTeacher() || 
                           (isAuthenticated() && request.auth.uid == resource.data.authorId);
                           
          // Likes for replies
          match /likes/{likeId} {
            allow read: if request.auth != null;
            // Users can only like with their own ID
            allow create: if request.auth != null 
              && request.auth.uid == likeId
              && request.auth.uid == request.resource.data.userId;
            // Users can only delete their own likes
            allow delete: if request.auth != null 
              && request.auth.uid == likeId;
            // Likes cannot be updated
            allow update: if false;
          }
        }
        
        // Likes for threads
        match /likes/{likeId} {
          allow read: if request.auth != null;
          // Users can only like with their own ID
          allow create: if request.auth != null 
            && request.auth.uid == likeId
            && request.auth.uid == request.resource.data.userId;
          // Users can only delete their own likes
          allow delete: if request.auth != null 
            && request.auth.uid == likeId;
          // Likes cannot be updated
          allow update: if false;
        }
      }
    }
    
    // Games - any authenticated user can read and create, only creator can update/delete
    match /games/{gameId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null 
        && resource.data.creatorId == request.auth.uid;
      
      // Scores - users can only create/update their own scores
      match /scores/{scoreId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null 
          && request.auth.uid == request.resource.data.studentId;
        allow update: if request.auth != null 
          && request.auth.uid == resource.data.studentId;
      }
    }
    
    
    // Scheduled messages - secured with sender validation
    match /scheduled_messages/{messageId} {
      allow read: if isAuthenticated() && 
                     request.auth.uid == resource.data.message.senderId;
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.message.senderId &&
                       true;
      allow update: if isAuthenticated() && 
                       request.auth.uid == resource.data.message.senderId &&
                       request.auth.uid == request.resource.data.message.senderId; // Can't change sender
      allow delete: if isAuthenticated() && 
                       request.auth.uid == resource.data.message.senderId;
    }
    
    // Discussion boards - teacher creates boards, all users can read
    match /discussion_boards/{boardId} {
      allow read: if request.auth != null;
      allow create: if isTheTeacher();
      allow update: if request.auth != null 
        && resource.data.createdBy == request.auth.uid;
      allow delete: if isTheTeacher(); // Only teachers can delete boards
      
      // Discussion threads
      match /threads/{threadId} {
        allow read: if request.auth != null;
        // Allow create if authenticated and setting self as author
        allow create: if request.auth != null 
          && request.auth.uid == request.resource.data.authorId;
        allow update: if request.auth != null 
          && (resource.data.authorId == request.auth.uid ||
              // Allow any authenticated user to update only the likeCount
              (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeCount']) &&
               (request.resource.data.likeCount == resource.data.likeCount + 1 ||
                request.resource.data.likeCount == resource.data.likeCount - 1)) ||
              // Allow any authenticated user to update only the replyCount
              (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyCount']) &&
               (request.resource.data.replyCount == resource.data.replyCount + 1 ||
                request.resource.data.replyCount == resource.data.replyCount - 1)));
        allow delete: if request.auth != null 
          && (isTheTeacher() || resource.data.authorId == request.auth.uid);
        
        // Thread comments (used by the app for discussion replies)
        match /comments/{commentId} {
          allow read: if request.auth != null;
          // Allow create if authenticated and setting self as author
          allow create: if request.auth != null 
            && request.auth.uid == request.resource.data.authorId;
          allow update: if request.auth != null 
            && resource.data.authorId == request.auth.uid;
          allow delete: if request.auth != null 
            && (isTheTeacher() || resource.data.authorId == request.auth.uid);
        }
        
        // Thread replies (legacy - kept for compatibility)
        match /replies/{replyId} {
          allow read: if request.auth != null;
          // Allow create if authenticated and setting self as author
          allow create: if request.auth != null 
            && request.auth.uid == request.resource.data.authorId;
          allow update: if request.auth != null 
            && (resource.data.authorId == request.auth.uid ||
                // Allow any authenticated user to update only the likeCount
                (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeCount']) &&
                 request.resource.data.likeCount == resource.data.likeCount + 1 ||
                 request.resource.data.likeCount == resource.data.likeCount - 1));
          allow delete: if request.auth != null 
            && (isTheTeacher() || resource.data.authorId == request.auth.uid);
            
          // Likes for replies
          match /likes/{likeId} {
            allow read: if request.auth != null;
            // Users can only like with their own ID
            allow create: if request.auth != null 
              && request.auth.uid == likeId
              && request.auth.uid == request.resource.data.userId;
            // Users can only delete their own likes
            allow delete: if request.auth != null 
              && request.auth.uid == likeId;
            // Likes cannot be updated
            allow update: if false;
          }
        }
        
        // Likes for threads
        match /likes/{likeId} {
          allow read: if request.auth != null;
          // Users can only like with their own ID
          allow create: if request.auth != null 
            && request.auth.uid == likeId
            && request.auth.uid == request.resource.data.userId;
          // Users can only delete their own likes
          allow delete: if request.auth != null 
            && request.auth.uid == likeId;
          // Likes cannot be updated
          allow update: if false;
        }
      }
    }
    
    // Calendar events - users can create/manage their own events, view if participants
    match /calendar_events/{eventId} {
      allow read: if request.auth != null 
        && (resource.data.createdBy == request.auth.uid 
          || request.auth.uid in resource.data.participantIds);
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.createdBy;
      allow update: if request.auth != null 
        && resource.data.createdBy == request.auth.uid;
      allow delete: if request.auth != null 
        && resource.data.createdBy == request.auth.uid;
    }
    
    // Students collection - for student-specific data
    match /students/{studentId} {
      // Students can read their own data (by userId field), teacher can read all
      allow read: if request.auth != null && 
        (isTheTeacher() || 
         resource == null ||
         (isStudent() && (request.auth.uid == studentId || 
          (resource.data.userId != null && request.auth.uid == resource.data.userId))));
      
      // Students can update their own profile data
      allow update: if isStudent() && 
        (request.auth.uid == studentId || request.auth.uid == resource.data.userId);
      
      // Only teacher can create or delete student records
      allow create, delete: if isTheTeacher();
    }
    
    // Teachers collection - for teacher-specific data
    match /teachers/{teacherId} {
      // Only the teacher can read/write their own data
      allow read, write: if isTheTeacher() && request.auth.uid == teacherId;
    }
    
    // Calls collection - for video/voice calls
    match /calls/{callId} {
      // Allow read if authenticated AND either:
      // - Document doesn't exist (for checking before creation) OR
      // - User is a participant OR
      // - Call is ringing (for incoming calls)
      allow read: if isAuthenticated() && 
                     (resource == null ||
                      request.auth.uid == resource.data.callerId || 
                      request.auth.uid == resource.data.receiverId ||
                      resource.data.status == 'ringing');
      
      // Only authenticated users with verified email can create calls
      allow create: if isAuthenticated() &&
                       request.auth.uid == request.resource.data.callerId &&
                       true;
      
      // Allow participants to update call status
      allow update: if isAuthenticated() && 
                       (request.auth.uid == resource.data.callerId || 
                        request.auth.uid == resource.data.receiverId) &&
                       // Only allow status transitions to ending states
                       (request.resource.data.status in ['ended', 'rejected', 'missed', 'answered'] || 
                        resource.data.status == 'ringing');
      
      // No deletion of call records
      allow delete: if false;
      
      // ICE candidates subcollection for WebRTC
      match /candidates/{userId}/candidates/{candidateId} {
        allow read, write: if isAuthenticated() && 
                             (request.auth.uid == get(/databases/$(database)/documents/calls/$(callId)).data.callerId || 
                              request.auth.uid == get(/databases/$(database)/documents/calls/$(callId)).data.receiverId);
      }
    }
    
    // Activities collection - for dashboard recent activities
    match /activities/{activityId} {
      // Admins can read all activities
      // Teachers can read activities where they are the teacher
      // Students can read activities for their classes
      allow read: if request.auth != null && 
        (isAdmin() || isTheTeacher() ||
         isTheTeacher() || 
         resource == null ||
         (isStudent() && resource.data.classId != null && 
          request.auth.uid in get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.studentIds));
      
      // Admin, system or teacher can create activities
      allow create: if request.auth != null && 
        (isAdmin() || isTheTeacher() ||
         isTheTeacher() || 
         request.resource.data.userId == request.auth.uid);
      
      // Only admins can update or delete activities (for cleanup)
      allow update, delete: if isAdmin() || isTheTeacher();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if request.auth != null && 
        (resource == null ||
         request.auth.uid == resource.data.userId);
      
      // System or teacher can create notifications
      allow create: if request.auth != null && 
        (isTheTeacher() || 
         request.auth.uid == request.resource.data.userId);
      
      // Users can update their own notifications (mark as read)
      allow update: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // Users can delete their own notifications
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.userId;
    }
    
    // FCM tokens - users can manage their own tokens
    match /fcm_tokens/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Bug reports collection
    match /bug_reports/{reportId} {
      // Only teachers can read bug reports (for admin purposes)
      allow read: if isTheTeacher();
      
      // Any authenticated user with verified email can create a bug report
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.userId &&
                       true;
      
      // Bug reports are immutable once submitted
      allow update, delete: if false;
    }
    
    // Jeopardy games collection - for educational game templates
    match /jeopardy_games/{gameId} {
      // Allow read if:
      // - User is authenticated and game is public OR
      // - User is the teacher who created the game OR
      // - Document doesn't exist (checking before creation)
      allow read: if isAuthenticated() && 
                     (resource == null ||
                      (resource.data.isPublic == true) ||
                      (resource.data.teacherId == request.auth.uid));
      
      // Only teachers can create games
      allow create: if isTheTeacher() && 
                       request.auth.uid == request.resource.data.teacherId &&
                       true;
      
      // Only the teacher who created the game can update it
      allow update: if isTheTeacher() && 
                       resource.data.teacherId == request.auth.uid &&
                       // Prevent changing the teacherId
                       request.resource.data.teacherId == resource.data.teacherId;
      
      // Only the teacher who created the game can delete it
      allow delete: if isTheTeacher() && 
                       resource.data.teacherId == request.auth.uid;
    }
    
    // Jeopardy game sessions - for active gameplay
    match /jeopardy_sessions/{sessionId} {
      // Allow read if user is a participant or the teacher
      allow read: if isAuthenticated() && 
                     (resource == null ||
                      resource.data.teacherId == request.auth.uid ||
                      request.auth.uid in resource.data.participantIds);
      
      // Only teachers can create sessions
      allow create: if isTheTeacher() && 
                       request.auth.uid == request.resource.data.teacherId &&
                       true;
      
      // Teacher or participants can update (for game state)
      allow update: if isAuthenticated() && 
                       (resource.data.teacherId == request.auth.uid ||
                        request.auth.uid in resource.data.participantIds);
      
      // Only the teacher can delete sessions
      allow delete: if isTheTeacher() && 
                       resource.data.teacherId == request.auth.uid;
    }
    
    // Presence collection - for tracking online users
    match /presence/{userId} {
      // All authenticated users can read presence documents to see who's online
      allow read: if isAuthenticated();
      
      // Users can only create/update their own presence document
      allow create: if isAuthenticated() && 
                       request.auth.uid == userId;
      
      // Users can only update their own presence document
      allow update: if isAuthenticated() && 
                       request.auth.uid == userId;
      
      // Users can delete their own presence document (when going offline)
      allow delete: if isAuthenticated() && 
                       request.auth.uid == userId;
    }
    
    // Default deny rule - explicitly deny any unmatched paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// PRODUCTION RULES - Key Security Features:
// 1. Email verification required for content creation
// 2. Role-based access control with teacher/student separation
// 3. Immutable messages and audit records
// 4. Student enrollment validation for class content
// 5. Owner-only write access for user-generated content
// 6. No deletion of critical records (messages, calls, activities)
// 7. Default deny for unmatched paths